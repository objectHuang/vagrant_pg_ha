---
# PostgreSQL HA Cluster Playbook with Patroni + etcd

- name: Setup PostgreSQL HA Cluster
  hosts: pg_cluster
  become: true
  vars:
    pg_version: "16"
    patroni_scope: "pg-cluster"
    etcd_version: "v3.5.11"
    
    # Generate cluster info from inventory (using node_ip from Vagrant host_vars)
    etcd_initial_cluster: "{{ groups['pg_cluster'] | map('extract', hostvars, ['inventory_hostname']) | zip(groups['pg_cluster'] | map('extract', hostvars, ['node_ip'])) | map('join', '=http://') | map('regex_replace', '$', ':2380') | join(',') }}"
    etcd_endpoints: "{{ groups['pg_cluster'] | map('extract', hostvars, ['node_ip']) | map('regex_replace', '$', ':2379') | join(',') }}"

  tasks:
    # ==================== Phase 1: Install packages on ALL nodes ====================
    - name: Install prerequisites
      apt:
        name:
          - wget
          - gnupg2
          - lsb-release
          - curl
          - python3
          - python3-pip
          - python3-venv
          - acl
        state: present
        update_cache: true

    - name: Add PostgreSQL repository key
      apt_key:
        url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
        state: present

    - name: Add PostgreSQL repository
      apt_repository:
        repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
        state: present

    - name: Install PostgreSQL
      apt:
        name:
          - "postgresql-{{ pg_version }}"
          - "postgresql-contrib-{{ pg_version }}"
        state: present
        update_cache: yes

    - name: Stop and disable default PostgreSQL
      systemd:
        name: postgresql
        state: stopped
        enabled: no

    - name: Install Patroni
      pip:
        name:
          - patroni[etcd]
          - psycopg2-binary
        state: present

    # ==================== Phase 2: Install etcd on ALL nodes ====================
    - name: Download etcd
      get_url:
        url: "https://github.com/etcd-io/etcd/releases/download/{{ etcd_version }}/etcd-{{ etcd_version }}-linux-amd64.tar.gz"
        dest: /tmp/etcd.tar.gz

    - name: Extract etcd
      unarchive:
        src: /tmp/etcd.tar.gz
        dest: /tmp/
        remote_src: yes

    - name: Install etcd binaries
      copy:
        src: "/tmp/etcd-{{ etcd_version }}-linux-amd64/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        mode: '0755'
        remote_src: yes
      loop:
        - etcd
        - etcdctl

    - name: Create etcd user
      user:
        name: etcd
        system: yes
        shell: /bin/false
        create_home: no

    - name: Create etcd data directory
      file:
        path: /var/lib/etcd
        state: directory
        owner: etcd
        group: etcd
        mode: '0700'

    - name: Create etcd systemd service
      template:
        src: etcd.service.j2
        dest: /etc/systemd/system/etcd.service
      notify: Reload systemd

    # ==================== Phase 3: Configure Patroni on ALL nodes ====================
    - name: Create Patroni directories
      file:
        path: "{{ item }}"
        state: directory
        owner: postgres
        group: postgres
        mode: '0700'
      loop:
        - /etc/patroni
        - /var/lib/patroni
        - "/var/lib/patroni/{{ patroni_scope }}"

    - name: Ensure PostgreSQL data directory has correct permissions
      file:
        path: "/var/lib/patroni/{{ patroni_scope }}"
        state: directory
        owner: postgres
        group: postgres
        mode: '0700'
        recurse: yes

    - name: Create Patroni configuration
      template:
        src: patroni.yml.j2
        dest: /etc/patroni/patroni.yml
        owner: postgres
        group: postgres
        mode: '0600'

    - name: Create Patroni systemd service
      template:
        src: patroni.service.j2
        dest: /etc/systemd/system/patroni.service
      notify: Reload systemd

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    # ==================== Phase 4: Start etcd on ALL nodes SIMULTANEOUSLY ====================
    - name: Start etcd on all nodes
      systemd:
        name: etcd
        state: started
        enabled: yes
      # This runs on all nodes in parallel!

    - name: Wait for etcd cluster to form
      command: etcdctl endpoint health
      register: etcd_health
      retries: 30
      delay: 5
      until: etcd_health.rc == 0
      run_once: true

    - name: Display etcd members
      command: etcdctl member list
      register: etcd_members
      run_once: true

    - name: Show etcd cluster
      debug:
        var: etcd_members.stdout_lines
      run_once: true

    # ==================== Phase 5: Start Patroni on ALL nodes SIMULTANEOUSLY ====================
    - name: Start Patroni on all nodes
      systemd:
        name: patroni
        state: started
        enabled: true

    - name: Wait for Patroni to initialize
      pause:
        seconds: 15

    - name: Check Patroni cluster status
      command: patronictl -c /etc/patroni/patroni.yml list
      register: patroni_status
      run_once: true
      ignore_errors: true

    - name: Show Patroni cluster status
      debug:
        var: patroni_status.stdout_lines
      run_once: true

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: true
